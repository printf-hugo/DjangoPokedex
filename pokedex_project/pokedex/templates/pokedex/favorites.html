{% extends 'pokedex/base.html' %}
{% block title %}Meus Favoritos{% endblock %}

{% block extra_css %}
<style>
    .favorites-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
    #loading-state { text-align: center; font-size: 1.5em; padding: 50px; }
    .filter-container { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    #type-filter { padding: 8px; background-color: var(--surface-color); color: var(--primary-text); border: 1px solid var(--border-color); border-radius: 5px; }
    .pokemon-card { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 15px; padding: 20px; text-align: center; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
    .pokemon-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.4); }
    .pokemon-card a { color: inherit; text-decoration: none; }
    .pokemon-card img { width: 120px; height: 120px; margin: -40px auto 10px auto; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }
    .pokemon-card h3 { margin: 0; text-transform: capitalize; font-size: 1.4em; }
    .pokemon-card .pokemon-id { color: var(--secondary-text); font-size: 0.9em; }
    .pokemon-card .types { margin: 10px 0; }
    .pokemon-card .types span { padding: 4px 12px; border-radius: 15px; margin: 0 4px; font-size: 0.8em; font-weight: bold; }
    .stats-container { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); text-align: left; font-size: 0.9em; }
    .stat { display: flex; justify-content: space-between; margin-bottom: 5px; text-transform: capitalize; }
    .notes-section { margin-top: 15px; flex-grow: 1; display: flex; flex-direction: column; gap: 10px; }
    .notes-section textarea { width: 100%; box-sizing: border-box; background: #383838; color: white; border: 1px solid #555; border-radius: 5px; padding: 8px; min-height: 70px; resize: vertical; }
    .card-actions { margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .save-note-btn { background-color: var(--success-color); color: white; }
    .remove-btn { background-color: var(--error-color); color: white; }

    .manual-tag-container { text-align: left; font-size: 0.9em; }
    .manual-tag-container select {
        width: 100%;
        padding: 8px;
        background-color: #383838;
        color: white;
        border: 1px solid #555;
        border-radius: 5px;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<h2>Meus Favoritos</h2>
<div class="filter-container">
    <label for="type-filter">Filtrar por tipo:</label>
    <select id="type-filter">
        <option value="all">Todos</option>
        <option value="normal">Normal</option><option value="fire">Fire</option><option value="water">Water</option><option value="electric">Electric</option><option value="grass">Grass</option><option value="ice">Ice</option><option value="fighting">Fighting</option><option value="poison">Poison</option><option value="ground">Ground</option><option value="flying">Flying</option><option value="psychic">Psychic</option><option value="bug">Bug</option><option value="rock">Rock</option><option value="ghost">Ghost</option><option value="dragon">Dragon</option><option value="dark">Dark</option><option value="steel">Steel</option><option value="fairy">Fairy</option>
    </select>
</div>
<div id="favorites-container" class="favorites-grid" data-detail-url-template="{% url 'api_favorite_detail' favorite_id=999999 %}">
    <div id="loading-state">Carregando seus favoritos...</div>
</div>
<script id="favorites-data" type="application/json">{{ favorites_json|safe }}</script>
<script id="all-tags-data" type="application/json">{{ all_tags_json|safe }}</script>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const container = document.getElementById('favorites-container');
    const loadingState = document.getElementById('loading-state');
    const favoritesData = JSON.parse(document.getElementById('favorites-data').textContent);
    const allTags = JSON.parse(document.getElementById('all-tags-data').textContent);

    if (favoritesData.length === 0) {
        loadingState.innerHTML = '<p>Você ainda não tem Pokémon favoritos. Use a busca para adicionar.</p>';
        return;
    }
    loadingState.remove();
    
    const tagOptionsHTML = `<option value="">Nenhuma</option>` + allTags.map(tag => `<option value="${tag.id}">${tag.name}</option>`).join('');

    for (const fav of favoritesData) {
        const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${fav.pokemon_id}`);
        if (!response.ok) continue;
        const pokemon = await response.json();
        
        const card = document.createElement('div');
        card.className = 'pokemon-card';
        card.dataset.id = fav.pk;
        card.dataset.types = pokemon.types.map(t => t.type.name).join(',');
        
        const selectedTagId = fav.tag ? fav.tag.id : '';

        card.innerHTML = `
            <a href="{% url 'index' %}?pokemon=${pokemon.id}">
                <img src="${pokemon.sprites.front_default}" alt="${pokemon.name}">
                <h3>${pokemon.name}</h3>
                <p class="pokemon-id">#${pokemon.id}</p>
                <div class="types">${pokemon.types.map(t => `<span style="background-color: var(--type-${t.type.name})">${t.type.name}</span>`).join('')}</div>
            </a>
            <div class="notes-section">
                <textarea class="note-input" placeholder="Suas anotações...">${fav.notes || ''}</textarea>
                <div class="manual-tag-container">
                    <strong>Tag:</strong>
                    <select class="manual-tag-select">${tagOptionsHTML}</select>
                </div>
            </div>
            <div class="card-actions">
                <button class="save-note-btn">Salvar</button>
                <button class="remove-btn">Remover</button>
            </div>
        `;
        card.querySelector('.manual-tag-select').value = selectedTagId;

        container.appendChild(card);
        addCardEventListeners(card);
    }
});

function addCardEventListeners(card) {
    const favId = card.dataset.id;
    const urlTemplate = document.getElementById('favorites-container').dataset.detailUrlTemplate;
    const finalUrl = urlTemplate.replace('999999', favId);
    
    card.querySelector('.save-note-btn').addEventListener('click', async () => {
        const newNote = card.querySelector('.note-input').value;
        const selectedTagId = card.querySelector('.manual-tag-select').value;

        const response = await fetch(finalUrl, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
            body: JSON.stringify({ notes: newNote, tag_id: selectedTagId })
        });
        showNotification(response.ok ? 'Favorito salvo!' : 'Erro ao salvar.', response.ok ? 'success' : 'error');
    });

    card.querySelector('.remove-btn').addEventListener('click', async () => {
        if (!confirm('Remover este Pokémon dos favoritos?')) return;
        const response = await fetch(finalUrl, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
        if (response.ok) {
            card.remove();
            showNotification('Favorito removido.');
        } else { 
            showNotification('Erro ao remover.', 'error');
        }
    });
}
document.getElementById('type-filter').addEventListener('change', (event) => {
    const selectedType = event.target.value;
    document.querySelectorAll('.pokemon-card').forEach(card => {
        const cardTypes = card.dataset.types.split(',');
        card.style.display = (selectedType === 'all' || cardTypes.includes(selectedType)) ? 'flex' : 'none';
    });
});
</script>
{% endblock %}